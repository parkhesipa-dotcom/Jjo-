#!/usr/bin/env python3
import argparse
import time
import uuid
import json
import statistics
from concurrent.futures import ThreadPoolExecutor, as_completed
import requests

def payload_builder(pan, unique_id):
    # Change payload shape here if needed
    return {"pan": pan, "uniqueId": unique_id}

def hit_endpoint(url, pan, verify_ssl=True, timeout=30):
    unique_id = str(uuid.uuid4())
    payload = payload_builder(pan, unique_id)
    headers = {"Content-Type": "application/json"}

    start = time.perf_counter()
    try:
        resp = requests.post(url, json=payload, headers=headers, timeout=timeout, verify=verify_ssl)
        elapsed = (time.perf_counter() - start) * 1000
        return {"status": resp.status_code, "elapsed_ms": elapsed}
    except Exception as e:
        elapsed = (time.perf_counter() - start) * 1000
        return {"status": "ERROR", "elapsed_ms": elapsed, "error": str(e)}

def run_benchmark(url, pan, runs=100, verify_ssl=True):
    print(f"âš¡ Launching {runs} parallel requests...\n")
    results = []
    start_all = time.perf_counter()

    with ThreadPoolExecutor(max_workers=runs) as executor:
        futures = [executor.submit(hit_endpoint, url, pan, verify_ssl) for _ in range(runs)]
        for i, future in enumerate(as_completed(futures), 1):
            result = future.result()
            results.append(result)
            status = result.get("status")
            elapsed = result.get("elapsed_ms")
            print(f"{i:03d}. {status} - {elapsed:.2f} ms")

    total_time = (time.perf_counter() - start_all) * 1000
    valid_times = [r["elapsed_ms"] for r in results if isinstance(r.get("elapsed_ms"), (int, float))]

    print("\nðŸ“Š Summary:")
    if valid_times:
        print(f"  Successful hits : {len(valid_times)}/{runs}")
        print(f"  Min time (ms)   : {min(valid_times):.2f}")
        print(f"  Max time (ms)   : {max(valid_times):.2f}")
        print(f"  Avg time (ms)   : {statistics.mean(valid_times):.2f}")
        print(f"  Median (ms)     : {statistics.median(valid_times):.2f}")
        print(f"  Total batch time: {total_time:.2f} ms ({total_time/1000:.2f} sec)")
    else:
        print("  No successful results.")

    json.dump(results, open("times_100.json", "w"), indent=2)
    print("\nâœ… Results saved to times_100.json")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Send 100 parallel requests to RBI API")
    parser.add_argument("--url", required=True, help="Target endpoint URL (e.g. http://localhost:5000/verify_lrs)")
    parser.add_argument("--pan", required=True, help="PAN number (10 chars)")
    parser.add_argument("--insecure", action="store_true", help="Disable SSL verification")
    args = parser.parse_args()

    run_benchmark(args.url, args.pan, runs=100, verify_ssl=not args.insecure)
