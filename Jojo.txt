import base64, json, requests
from Crypto.Cipher import AES, PKCS1_OAEP
from Crypto.PublicKey import RSA
from Crypto.Random import get_random_bytes
from Crypto.Hash import SHA256
import html

IV_SIZE = 12
TAG_SIZE = 16

# RBI public certificate exactly as provided (BEGIN/END included)
rbi_public_cert = """-----BEGIN PUBLIC KEY-----
<PASTE YOUR CERT HERE>
-----END PUBLIC KEY-----
"""

# AES-GCM encryption/decryption
def aes_gcm_encrypt(plain_text: str, key: bytes) -> str:
    iv = get_random_bytes(IV_SIZE)
    cipher = AES.new(key, AES.MODE_GCM, nonce=iv)
    ciphertext, tag = cipher.encrypt_and_digest(plain_text.encode("utf-8"))
    encrypted_bytes = iv + ciphertext + tag
    return base64.b64encode(encrypted_bytes).decode("utf-8")

def aes_gcm_decrypt(encrypted_b64: str, key: bytes) -> str:
    decoded_data = base64.b64decode(encrypted_b64)
    iv = decoded_data[:IV_SIZE]
    tag = decoded_data[-TAG_SIZE:]
    ciphertext = decoded_data[IV_SIZE:-TAG_SIZE]
    cipher = AES.new(key, AES.MODE_GCM, nonce=iv)
    decrypted = cipher.decrypt_and_verify(ciphertext, tag)
    return decrypted.decode("utf-8")


# ðŸ”¹ Function callable by controller
def build_lrs_payload(pan: str, unique_id: str):
    # Step 1 â€“ Credentials
    client_id = "<CLIENT_ID>"
    client_secret = "<CLIENT_SECRET>"
    api_url = "<API_URL>"

    # Step 2 â€“ Generate AES key
    aes_key = get_random_bytes(32)
    aes_keyb64 = base64.b64encode(aes_key).decode("utf-8")

    # Step 3 â€“ Encrypt client auth info
    client_auth_plain = f"{client_id}*{client_secret}"
    encrypted_client_auth = aes_gcm_encrypt(client_auth_plain, aes_key)

    # Step 4 â€“ Encrypt PAN data body
    data_body = [
        {
            "structureRefVo": {"code": "LRSDATA", "version": 1, "agencyID": "RBI"},
            "obs": [{"pan": [pan]}],
        }
    ]
    encrypted_body = aes_gcm_encrypt(json.dumps(data_body), aes_key)

    # Step 5 â€“ Encrypt AES key with RBI public key
    public_key = RSA.import_key(rbi_public_cert)
    cipher_rsa = PKCS1_OAEP.new(public_key, hashAlgo=SHA256)
    rsa_encrypted_key = cipher_rsa.encrypt(aes_keyb64.encode("utf-8"))
    encrypted_key_data = base64.b64encode(rsa_encrypted_key).decode("utf-8")

    # Step 6 â€“ Construct final JSON
    final_body = {
        "header": {
            "authinfo": {
                "LoginParams": ["CLIENT_AUTH_INFO", encrypted_client_auth],
                "UserType": "SYSTEM",
                "AuthenticationType": "API_AUTH",
                "Key_data": encrypted_key_data,
            }
        },
        "body": {"LRS_body": encrypted_body, "uniqueId": unique_id},
    }

    # âœ… return the full encrypted payload
    return final_body
