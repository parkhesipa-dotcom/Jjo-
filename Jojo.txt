 # pan_service.py
import requests
from google.cloud import secretmanager
import google.auth  # ✅ used to fetch default project automatically


def get_secret(secret_id: str):
    """
    Fetch secret value from GCP Secret Manager securely.
    Automatically detects project ID using application default credentials.
    """
    # ✅ Get project_id dynamically (no env vars required)
    credentials, project_id = google.auth.default()

    client = secretmanager.SecretManagerServiceClient()
    name = f"projects/{project_id}/secrets/{secret_id}/versions/latest"
    response = client.access_secret_version(request={"name": name})
    return response.payload.data.decode("UTF-8")


def fetch_pan_details(pan, consent, case_id, lite):
    print("log3")

    # ✅ Fetch Karza key securely from Secret Manager
    karza_key = get_secret("KARZA_API_KEY")

    url = "https://testapi.karza.in/v3/pan-profile"
    payload = {
        "pan": pan,
        "lite": lite,
        "consent": consent,
        "clientData": {"caseId": case_id}
    }

    headers = {
        "Content-Type": "application/json",
        "x-karza-key": karza_key
    }

    try:
        response = requests.post(url, json=payload, headers=headers, verify=False)
        print(response)
        response.raise_for_status()
        return response.json()

    except requests.exceptions.RequestException as e:
        return {"error": str(e)}
